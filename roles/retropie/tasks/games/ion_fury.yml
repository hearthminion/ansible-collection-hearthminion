- name: Print Variables
  debug:
    msg:
      - "Game: {{ game.name }}"
      - "Full Name: {{ game.full_name }}"
      - "Installer Directory: {{ gog_dir }}/{{ game.name}}/"
      - "Installer: {{ gog_dir }}/{{ game.name }}/{{ game.installer }}"
      - "User: {{ game_user }}"
    verbosity: 2

- name: "Checkout My eduke32 bugfixes branch"
  command: "git checkout bugfix/eduke"
  args:
    chdir: "/opt/RetroPie-Setup"
  become: yes
  become_user: "{{ game_user }}"

- name: "Install {{ game.name }}"
  command: "retropie_packages.sh eduke32 {{ item }}"
  become: yes
  become_user: "{{ game_user }}"
  loop: "{{ game.retropie_commands }}"

- name: "Return to development branch"
  command: "git checkout develop"
  args:
    chdir: "/opt/RetroPie-Setup"
  become: yes
  become_user: "{{ game_user }}"

- name: "Extract {{ game.name }}"
  script:
    cmd: "{{ gog_dir }}/{{ game.name }}/{{ installer }} -- --i-agree-to-all-licenses --noreadme --nooptions --noprompt --destination /tmp/{{ game.name }}"
  become: yes
  become_user: "{{ game_user }}"

- name: "Install Data Files"
  file:
    src: "/tmp/{{ game.name }}/data/{{ item }}"
    dest: "/home/{{ game_user }}/RetroPie/roms/ports/duke3d/{{ item | lower }}"
    mode: "0644"
  become: yes
  become_user: "{{ game_user }}"
  loop: "{{ game.data_files }}"

# ======================================================================
#
# Remove temporary files
#
# Further debugging needed.  The command successfully removes all
# installation files, but reports a failure.
#
# ======================================================================
- name: "Remove temporary files"
  command: "/tmp/{{ game.name }}/uninstall-Duke Nukem 3D Atomic Edition.sh"
  become: yes
  become_user: "{{ game_user }}"
  ignore_errors: True

- name: "Ensure temporary files are gone"
  file:
    path: "/tmp/{{ game.name }}"
    state: absent

- name: "Clean-Up the Desktop"
  file:
    path: "/home/{{ game_user }}/Desktop/{{ item }}"
    state: absent
  loop: "{{ game.desktop_files }}"
